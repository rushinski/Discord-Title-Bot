"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const autoUnregister = async (emitter, action) => {
    const emitter_ = await emitter;
    const getListeners = () => {
        return emitter_
            .eventNames()
            .reduce((map, event) => map.set(event, emitter_.listeners(event)), new Map());
    };
    const prevListeners = getListeners();
    const promise = action instanceof Promise ? action : action(emitter_);
    const offListeners = [...getListeners()].map(([event, listeners]) => [
        event,
        listeners.filter((listener) => !prevListeners.get(event)?.includes(listener))
    ]);
    try {
        return await promise;
    }
    finally {
        offListeners.forEach(([event, listeners]) => {
            listeners.forEach((listener) => {
                emitter_.off(event, listener);
            });
        });
    }
};
exports.default = autoUnregister;
